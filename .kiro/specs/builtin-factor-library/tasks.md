# 内置因子库及策略配置增强功能实施计划

## 项目概述

本实施计划将在现有量化选股系统基础上增加内置因子库和策略配置管理功能，包含20+技术指标、完整权重配置、策略保存复用等核心功能。

## 数据库和模型层实现

- [x] 1. 扩展数据库模型和表结构
  - 为内置因子、策略配置、因子分析创建新的数据表
  - 定义完整的Pydantic模型和SQLAlchemy映射
  - _需求: 需求2.2, 需求2.4 - 策略配置存储和管理_

- [ ] 1.1 创建内置因子定义表和模型
  - 创建builtin_factors表，包含因子定义、参数schema、计算方法等字段
  - 实现BuiltinFactor和FactorParameters Pydantic模型
  - 创建SQLAlchemy模型映射和数据库迁移脚本
  - _需求: 需求1.2, 需求1.3 - 内置因子库展示和参数配置_

- [ ] 1.2 创建策略配置表和模型
  - 创建strategy_configs表，支持因子配置、权重、标签等完整信息存储
  - 实现StrategyConfig、SavedStrategy、SelectedFactor模型
  - 添加策略版本管理和使用统计字段
  - _需求: 需求2.4, 需求2.5, 需求2.6 - 策略保存、加载和管理_

- [ ] 1.3 创建因子统计分析表和模型
  - 创建factor_statistics表，存储因子统计特征和有效性指标
  - 实现FactorStatistics、EffectivenessMetrics模型
  - 设计支持时间序列统计分析的数据结构
  - _需求: 需求4.1, 需求4.6 - 因子统计分析和有效性评估_

- [ ] 1.4 创建策略模板表和因子相关性表
  - 创建strategy_templates表，预设策略模板定义
  - 创建factor_correlations表，存储因子间相关性分析结果
  - 实现StrategyTemplate、CorrelationMatrix等模型
  - _需求: 需求3.2, 需求3.3, 需求4.3 - 策略模板和因子相关性分析_

## 内置因子库核心实现

- [ ] 2. 实现内置因子库核心功能
  - 实现20+常见技术指标的计算逻辑
  - 创建因子计算引擎和参数验证系统
  - _需求: 需求1.2, 需求1.4 - 内置因子提供和参数自定义_

- [ ] 2.1 实现趋势类因子计算（MA、EMA、布林带等）
  - 实现TrendFactors类，包含SMA、EMA、BOLL、MA交叉等指标
  - 支持可配置周期参数（5、10、20、50、200日等）
  - 添加参数验证和异常处理逻辑
  - _需求: 需求1.2 - 提供MA5、MA10、MA20、MA50、MA200等指标_

- [ ] 2.2 实现动量类因子计算（RSI、MACD、KDJ等）
  - 实现MomentumFactors类，包含RSI、MACD、KDJ、随机振荡器等
  - 支持多参数配置（RSI周期、MACD快慢线、KDJ参数等）
  - 确保计算结果与市场标准指标一致
  - _需求: 需求1.2 - 提供RSI、MACD、KDJ等动量指标_

- [ ] 2.3 实现价量类因子计算（OBV、MFI、成交量比率等）
  - 实现VolumeFactors类，包含OBV、MFI、VPT、成交量比率等
  - 处理价量结合的复合计算逻辑
  - 添加成交量数据缺失的异常处理
  - _需求: 需求1.2 - 提供成交量比率等价量类指标_

- [ ] 2.4 创建内置因子计算引擎和注册系统
  - 实现BuiltinFactorCalculator主计算引擎
  - 创建因子注册表，支持动态因子发现和调用
  - 实现因子计算缓存机制，提升性能
  - 添加批量因子并行计算支持
  - _需求: 需求1.6, 需求1.7 - 因子可用性验证和错误处理_

## 策略配置管理后端

- [ ] 3. 实现策略配置管理后端服务
  - 创建完整的策略配置管理服务层
  - 支持策略的增删改查、导入导出、版本管理
  - _需求: 需求2.4, 需求2.8, 需求2.10 - 策略保存、导入导出_

- [ ] 3.1 实现策略配置CRUD操作服务
  - 创建StrategyConfigService，实现策略的创建、读取、更新、删除
  - 支持策略列表查询、搜索、分页功能
  - 实现策略使用统计和历史记录
  - _需求: 需求2.5, 需求2.6 - 策略查看和加载_

- [ ] 3.2 实现权重配置验证和优化服务
  - 创建WeightValidationService，确保权重总和为100%
  - 实现权重自动标准化和手动调整功能
  - 提供等权重、市值加权等预设权重方案
  - _需求: 需求2.1, 需求2.2, 需求2.3 - 权重配置界面和验证_

- [ ] 3.3 实现策略导入导出功能
  - 实现策略配置JSON格式导出功能
  - 支持策略文件导入和格式验证
  - 添加导入冲突处理和版本兼容性检查
  - _需求: 需求2.10 - 策略配置JSON导出_

- [ ] 3.4 实现策略模板管理服务
  - 创建StrategyTemplateService，管理预设策略模板
  - 实现5个预设模板：价值投资、成长股、技术面、动量、质量因子
  - 支持模板应用和个性化调整
  - _需求: 需求3.2, 需求3.3, 需求3.4 - 策略模板和应用_

## 因子分析服务实现

- [ ] 4. 实现因子分析和统计服务
  - 创建因子统计分析、相关性计算、有效性评估服务
  - 支持因子特征对比和可视化数据生成
  - _需求: 需求4.1, 需求4.3, 需求4.6 - 因子统计分析和相关性_

- [ ] 4.1 实现因子统计特征分析服务
  - 创建FactorStatisticsService，计算均值、方差、分位数等统计指标
  - 实现因子数值分布分析和异常值检测
  - 生成因子稳定性指标和数据质量报告
  - _需求: 需求4.1 - 因子统计特征分析_

- [ ] 4.2 实现因子相关性计算服务
  - 创建FactorCorrelationService，计算因子间相关系数矩阵
  - 实现相关性显著性检验和P值计算
  - 提供高相关因子识别和权重优化建议
  - _需求: 需求4.3, 需求4.5 - 因子相关性矩阵和权重建议_

- [ ] 4.3 实现因子有效性分析服务
  - 创建FactorEffectivenessService，计算因子区分度和单调性
  - 实现分位数分析和股票分组有效性测试
  - 生成因子有效性评分和使用建议
  - _需求: 需求4.6 - 因子区分度指标计算_

## 后端API接口实现

- [ ] 5. 实现后端API接口
  - 为所有新功能创建RESTful API接口
  - 确保接口符合现有系统的设计规范
  - _需求: 所有功能需求的API支持_

- [ ] 5.1 实现内置因子库API接口
  - 创建内置因子列表、详情、预览、参数验证API
  - 实现因子分类查询和搜索功能
  - 添加因子计算结果预览和样本数据展示
  - _需求: 需求1.1, 需求1.3, 需求1.5 - 因子库显示和预览_

- [ ] 5.2 实现策略配置管理API接口  
  - 创建策略配置增删改查API
  - 实现策略导入导出、批量操作API
  - 添加策略使用统计和历史记录查询
  - _需求: 需求2.4, 需求2.8, 需求2.9 - 策略保存、删除、导出_

- [ ] 5.3 实现因子分析API接口
  - 创建因子统计分析、相关性计算API
  - 实现因子对比分析和有效性评估API
  - 提供分析结果的图表数据格式化
  - _需求: 需求4.1, 需求4.2, 需求4.3 - 因子分析功能_

- [ ] 5.4 实现策略模板和向导API接口
  - 创建策略模板查询和应用API
  - 实现权重预设方案和优化建议API
  - 添加策略预览和配置验证接口
  - _需求: 需求3.2, 需求3.5, 需求3.6 - 模板应用和配置向导_

## 前端组件开发

- [ ] 6. 实现前端核心组件
  - 创建内置因子库、策略配置、因子分析等前端组件
  - 集成到现有量化选股页面中
  - _需求: 需求1.1, 需求2.1, 需求4.2 - 前端界面展示_

- [ ] 6.1 实现内置因子库前端组件
  - 创建因子分类标签和因子卡片组件
  - 实现因子预览弹窗和参数配置界面
  - 添加因子搜索和筛选功能
  - _需求: 需求1.1, 需求1.3, 需求1.4 - 因子库分类和参数配置_

- [ ] 6.2 实现策略配置管理组件
  - 创建权重配置界面，支持滑块、数值输入、饼图显示
  - 实现策略管理列表和CRUD操作界面
  - 添加策略导入导出和批量操作功能
  - _需求: 需求2.1, 需求2.2, 需求2.5 - 权重配置和策略管理界面_

- [ ] 6.3 实现策略配置向导组件
  - 创建多步骤配置向导，包含模板选择、因子选择、权重配置等步骤
  - 实现策略预览和配置验证界面
  - 添加向导进度指示和步骤导航
  - _需求: 需求3.1, 需求3.5, 需求3.6 - 配置向导和预览功能_

- [ ] 6.4 实现因子分析前端组件
  - 创建因子相关性矩阵热力图组件
  - 实现因子统计特征对比图表
  - 添加因子有效性分析和可视化展示
  - _需求: 需求4.2, 需求4.1, 需求4.6 - 因子对比和相关性展示_

## 系统集成和测试

- [ ] 7. 集成现有选股策略执行引擎
  - 将内置因子集成到现有因子执行引擎中
  - 更新策略执行逻辑，支持内置因子和权重配置
  - _需求: 需求2.7 - 根据权重计算综合得分_

- [ ] 7.1 更新策略执行引擎支持内置因子
  - 修改现有FactorExecutionEngine，支持内置因子调用
  - 实现内置因子与自定义因子的统一接口
  - 添加因子计算结果缓存和性能优化
  - _需求: 需求1.6 - 内置因子可用性验证_

- [ ] 7.2 实现多因子权重计算逻辑
  - 更新策略执行服务，支持权重配置的综合得分计算
  - 实现公式：综合得分 = Σ(因子得分 × 因子权重)
  - 添加权重标准化和异常处理
  - _需求: 需求2.7 - 权重计算每只股票综合得分_

- [ ] 7.3 集成到现有量化选股界面
  - 将新组件集成到现有量化选股页面中
  - 更新页面路由和导航菜单
  - 确保与现有自定义因子功能的兼容性
  - _需求: 需求1.1 - 因子管理界面显示内置因子库_

## 数据初始化和优化

- [ ] 8. 初始化内置因子库数据
  - 创建20个内置因子的初始数据
  - 初始化5个策略模板数据
  - _需求: 需求1.2, 需求3.2 - 提供20个技术指标和5个策略模板_

- [ ] 8.1 创建内置因子初始数据
  - 定义并插入20个技术指标的因子定义数据
  - 包含趋势类(MA5,MA10,MA20,MA50,MA200,EMA,BOLL等)
  - 包含动量类(RSI,MACD,KDJ,STOCH等)和价量类(OBV,MFI,VPT等)指标
  - _需求: 需求1.2 - 至少20个常见技术指标因子_

- [ ] 8.2 创建策略模板初始数据
  - 创建5个预设策略模板：价值投资、成长股、技术面、动量、质量因子
  - 为每个模板配置合适的因子组合和默认权重
  - 添加模板说明、适用场景和使用建议
  - _需求: 需求3.2 - 至少5个预设策略模板_

- [ ] 8.3 实现性能优化和缓存
  - 实现因子计算结果缓存机制，使用Redis或内存缓存
  - 添加批量因子并行计算优化
  - 优化数据库查询性能，添加必要索引
  - _需求: 成功标准 - 因子统计分析10秒内完成，策略保存加载3秒内响应_

## 错误处理和用户体验

- [ ] 9. 完善错误处理和用户反馈
  - 为所有新功能添加完整的错误处理
  - 提供用户友好的错误提示和操作指导
  - _需求: 需求1.7, 需求4.7 - 错误处理和数据质量提示_

- [ ] 9.1 实现内置因子错误处理
  - 添加因子计算失败的错误处理和用户提示
  - 实现参数验证错误的详细反馈
  - 提供因子计算异常的故障排除建议
  - _需求: 需求1.7 - 内置因子计算失败错误信息_

- [ ] 9.2 实现策略配置错误处理
  - 添加权重配置错误的验证和提示
  - 实现策略导入失败的错误处理
  - 提供策略配置问题的修改建议
  - _需求: 需求2.9, 需求3.7 - 策略删除确认和配置问题提示_

## 测试和文档

- [ ] 10. 编写测试用例和文档
  - 为所有新功能编写单元测试和集成测试
  - 创建用户使用文档和API文档
  - _需求: 成功标准 - 内置因子计算准确率99.9%_

- [ ] 10.1 编写后端服务测试
  - 为因子计算引擎编写单元测试，验证计算准确性
  - 为策略配置服务编写集成测试
  - 为API接口编写接口测试
  - _需求: 成功标准 - 内置因子计算准确率达到99.9%_

- [ ] 10.2 编写前端组件测试
  - 为核心前端组件编写单元测试
  - 测试权重配置界面的交互逻辑
  - 验证因子分析图表的数据展示
  - _需求: 成功标准 - 用户2分钟内使用内置因子创建策略_

## 实施优先级

### 第一阶段（核心基础）
- 任务 1-1.4：数据库模型扩展
- 任务 2.1-2.4：内置因子库实现  
- 任务 5.1：内置因子API接口

### 第二阶段（策略配置）
- 任务 3.1-3.2：策略配置管理
- 任务 5.2：策略配置API
- 任务 6.1-6.2：前端组件开发

### 第三阶段（分析和向导）
- 任务 4.1-4.3：因子分析服务
- 任务 3.4：策略模板服务
- 任务 6.3-6.4：向导和分析组件

### 第四阶段（集成优化）
- 任务 7.1-7.3：系统集成
- 任务 8.1-8.3：数据初始化和优化
- 任务 9.1-10.2：错误处理和测试

## 关键技术决策

1. **因子计算性能**：使用缓存机制和并行计算，确保20个因子计算在合理时间内完成
2. **权重配置验证**：实时验证权重总和，提供自动标准化选项
3. **策略存储格式**：使用JSON格式存储复杂配置，支持版本兼容性
4. **因子扩展性**：设计插件式因子注册机制，便于未来添加新因子
5. **用户体验优化**：提供配置向导和预设模板，降低使用门槛

## 预期里程碑

- **第1-2周**：完成数据库扩展和内置因子库实现（任务1-2）
- **第3-4周**：完成策略配置管理和API接口（任务3，5.1-5.2）
- **第5-6周**：完成因子分析和前端组件（任务4，6.1-6.2）
- **第7-8周**：完成系统集成和测试优化（任务7-10）

每个任务完成后进行代码审查和功能验证，确保与需求的符合度和代码质量。